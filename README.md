# Tissue-photo-heating-with-NPs
Models IR photo heating of biological tissue with distributed NPs

## Описание модели
Модель состоит из двух основных частей:

- 1-ая часть `Light distribution.py` вычисляет распределение поглощённого света в среде. Расчёт ведётся методом Монте-Карло. Учитываются отражения от плоских граней области моделирования с возможностью полного внутреннего отражения, а также частичное отражение лазерного луча при освещении области моделирования из внешней среды.

- 2-ая часть `heat_diffusion.py` считает уравнение термодиффузии в области моделирования в течение времени облучения плюс некоторое время окончания облучения. Теплообмен с внешней средой считается через уравнение термической конвекции с поверхности. Размер шага по времени вычисляется автоматически исходя из устойчивости численного решения. Числовая схема для вычисления T(ti+1,ri) использует T(ti, ri-1), T(ti, ri-1), T(ti, ri-1), где r пробегает значения для всех осей.

## Работа с моделью
### Изменение параметров модели
Все доступные для изменений параметры модели находятся в файле параметров `SimulationParams.ini`. Для работы с моделью никаких изменений в код вносить не нужно. Файл параметров состоит из разделов, названия которых `[заключены в квадратные скобки]`. Комментарии в файле параметров следуют после строки с параметром, который они комментируют. Для каждого параметра указан диапазон доступных значений. Обратите внимание, что в коде модели отсутствует проверка корректности введённого значения параметров.

### Геометрия модели
Область моделирования представляет из себя параллелограмм. Геометрические параметры модели задаются в разделе `[Model Geometry]`. Названия параметров в этом разделе очевидны. `grid step` является шагом сетки для вычисления значений и используется в обеих частях модели. Параметры `data x/y/z size` означают количество точек по каждой из координат, они являются вычисляемыми `data size = model area / grid step` в коде первой части модели и их не нужно прописывать, после запуска первой части модели они будут перезаписаны.

### Оптические параметры
Для описания оптических свойств биологической ткани в модели используются 4 параметра, собранные в разделе `[Tissue optical params]`.
`tissue abs coef [1/cm]` - коэффициент поглощения.
`tissue sca coef [1/cm]` - коэффициент рассеяния (не приведённый!).
`g` – коэффициент анизотропии.
`n tissue` – показатель преломления ткани.

Оптические свойства внешней среды собраны в разделе `[External medium optical params]`. 
`n ext` – показатель преломления внешней, по отношению к области моделирования, среды из которой происходит облучение модели. Используется для вычисления доли излучения, прошедшего через границу раздела сред при облучении.

### Свойства НЧ
Параметры, касающиеся оптических свойств НЧ и их пространственного распределения внутри модели, собраны в разделе `[Nanoparticles params]`.
`np abs coef [1/cm]` – коэффициент поглощения НЧ. Этот параметр должен уже учитывать концентрацию НЧ в ткани.
`np sca coef [1/cm]` – коэффициент рассеяния (не приведённый) НЧ. Этот параметр должен уже учитывать концентрацию НЧ в ткани. 
В настоящий момент поддерживается 3 варианта пространственного распределения: НЧ отсутствуют, НЧ равномерно распределены внутри сферы, НЧ равномерно распределены внутри слоя. Тип используемого распределения задаётся параметром `np distribution`.
Параметры `x/y/z position of distribution center [mm]` задают положение центра сферического распределения, а параметр `distribution radius [mm]` – его радиус.
`np layer depth [mm]` – задаёт глубину под верхней гранью области моделирования, начиная с которой находится слой, содержащий НЧ при соответствующем распределении. Слой простирается до нижней грани области моделирования.

### Параметры излучения
Модель облучается сверху вниз перпендикулярно верхней грани коллимированным гауссовым пучком. Параметры излучения за исключением длительности собраны в разделе `[Illumination params]`. Длительность излучения задаётся в разделе `[Heat modelling params]`.
`beam width [mm]` – СО (SD, sigma) пучка. Таким образом диаметр пучка по уровню 1/e2 равняется `2*beam width [mm]`.
`center x/y` – положение центра лазурного луча.
`power [w]` – мощность лазерного излучения перед областью моделирования.

### Тепловые свойства области моделирования
Во второй части модели при решении задачи термичесской диффузии во время действия лазерного излучения источником тепла является распределение поглощенного света, посчитанное в первой части модели. После окончания действия лазерного излучения источники тепла в модели пропадают. Как уже было сказано выше, теплообмен с внешней средой реализован через уравнение тепловой конвекции. Тепловые параметры модели собраны в разделе `[Tissue params for heat]`.
`thermal conductivity [w/(m*k)]` – коэффициент теплопроводности.
`density [kg/m^3]` – плотность.
`specific heat [j/(kg*k)]` – теплоёмкость единицы массы.
`initial body temperature [k]` – температура внешней среды.
`convection heat loss [w/(m**2*k)]` - коэффициент поверхностной конвекции.

### Общие параметры модели поглощения света (1-ая часть модели)
Параметры собраны в разделе `[MonteCarlo Params]`.
`simulation mode` – Режим моделирования. В режиме `single` выполняет однократное моделирование с заданными параметрами. В режиме `calculate absorbed` производит серию моделирований с различными оптическими свойствами ткани и НЧ, а также при различной глубине залегания НЧ от облучаемой поверхности. Детали того, какие диапазоны параметров будут использованы указаны далее в этом же разделе.
`max iterations` – максимальное количество шагов, которые может сделать фотон. Если фотон дошагал до этого значение, то будет поглощён в текущей точке.
`photon count` – количество моделируемых фотонов.

### Общие параметры модели распространения тепла (2-ая часть модели)
Параметры собраны в 3 разделах: `[Heat modelling params]`, `[Heat save params]` и `[Heat iteration]`. 
`heating duration [s]` – время, в течение которого включен лазер.
`modelling duration [s]` – общее время моделирования распространения тепла.

`save full data` – переключатель сохранения массива с сечениями Y = 0 по всем временным точкам. Массив может быть позже использован для более наглядной визуализации, но занимает довольно много места.
`save heating curve 1/2/3` – переключатель сохранения кривых нагрева в определённых точках области моделирования.
`heating curve 1/2/3 x/y/z position [mm]` – координаты положения кривых для нагрева. Значения X/Y отсчитываются от центра области моделирования, Z – от верхней грани. 

### Оптимизация тепловых свойств
Программа может автоматически подбирать тепловые свойства фантома, чтобы соответствовать референтной кривой нагрева. Оптимизация выполняется по коэффициенту теплопроводности, теплоёмкости, плотности или любой комбинации двух из трёх параметров. Длительности облучения и общая длительность измерения в референтной кривой должна быть равна длительности нагрева и общей длительности, используемыми в модели. Нагрев в референтной кривой может начинаться не с самого начала. 
Параметры, отвечающие за оптимизацию тепловых свойств собраны в разделе `[Heat iteration]`.
`mode` – включение/отключение оптимизации.
`iterate thermal conductivity/density/specific heat` – выбор параметров, которые будут оптимизироваться. Одновременно можно выбрать не более 2 параметров.
`iterations per variable` – количество шагов при оптимизации каждой из переменных.
`iteration range [%]` – полный диапазон оптимизации переменных.
`reference curve x/y/z position [mm]` – координата референтной кривой.

`ref curve z1/z2/z3 [mm]` – параметры не имеют непосредственного отношения к оптимизации тепловых свойств. Используются для построения кривых нагрева в модуле визуализации `visualization_curves.py`, недоуступном в настоящее время. 

### Передача данных между модулями
Вычисленные параметры, которые служат для передачи данных между модулями собраны в разделе `[Technical data]`.
`absorbed light filename` – название файла с результатами моделирования поглощения света.
`heat_filename` – название файла, содержащего сечения Y = 0 для распространения тепла для всех временных точек.
`heating curves filename` – название файла, содержащего смоделированные кривые нагрева.
`reference curve filename` – название файла с референтными кривым.
`escaped top/side/bottom photons` – количество фотонов, вышедших за пределы области моделирования вверх/в стороны/вниз.
`absorbed photons` – количество поглощённых в области моделирования фотонов.
`reflected light` – доля фотонов, отражённых от верхней границы области моделирования при её облучении.

## Результаты моделирования
Результатом выполнения `Light distribution.py` является массив данных (формат numpy.int8) `.npy`, содержащий количества поглощенных фотонов во всех координатах области моделирования. Формат данных [Z,Y,X]. Размер массива `[data z size, data y size, data x size]`.
Файл сохраняется в папку /modeling results/. В названии файла отображены значения основных параметров модели.
Имя файла также сохраняется в раздел `[Technical data]` в поле `absorbed light filename`.

Результатом выполнения `Temperature distribution.py` является файл, содержащий данные по зависимости температуры (кривые нагрева) в трёх точках области моделирования, заданных в `[Heat save params][heating curve 1/2/3 x/y/z position [mm]]`. В файле содержится 6 столбцов: пары столбцов время/температура последовательно для каждой из кривых.
Файл сохраняется в папку /modeling results/. В названии файла отображены значения основных параметров модели.
Имя файла также сохраняется в раздел `[Technical data]` в поле `heating curves filename`.

Дополнительно в результате выполнения `Temperature distribution.py` может быть сгенерирован еще один файл (при установке `[Heat save params][save full data] = 1`), содержащий значения температуры в области моделирования в сечении `Y = (model area y)/2` с шагом по времени 1 с. Формат выходного массива [Z,time,X], размер [data z size, int(modelling time in sec + 2), data x size].
Файл сохраняется в папку /modeling results/. В названии файла отображены значения основных параметров модели.
Имя файла также сохраняется в раздел `[Technical data]` в поле `heat_filename`.

## Визуализация результатов
Для визуализации результатов распределения поглощенного излучения могут быть использованы 2 скрипта: `Light vizualization 2D.py` и `Light vizualization 3D.py`
`Light vizualization 2D.py` строит сечения Y = const области моделирования с поглощенными фотонами. Колёсиком мыши можно изменять значения Y и тем самым «проходить» всю область моделирования.
`Light vizualization 3D.py` строит 3-мерное изображение области моделирования. Визуализатор имеет 2 параметра:
Threshold – задаёт минимальное количество фотонов в точке, необходимое для отрисовки этой точки
Data size – объединяет несколько соседних точек в одну

Для визуализации результатов расчёта распространения тепла могут быть использован `Temperature vizualization.py`.
`Temperature vizualization.py` строит сечения Y = (model area y)/2 области моделирвоания с распределением температуры. Колёсиком мышки можно изменять значения времени после начала моделирвоания и тем самым «проходить» всё время моделирования.
